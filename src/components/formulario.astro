

---
import { procesarPedido } from '../actions';
---
<div class="min-h-screen flex items-center justify-center bg-gray-100 p-4">

  <form 
  id="pedidoForm" 
  method="POST"
  action={procesarPedido.url}
  class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-md space-y-4"
  >
  <div id="error-container"></div>
  <!-- Mantén el resto del HTML del formulario igual -->
  <h2 class="text-2xl font-bold text-center text-gray-700">Formulario de Pedido</h2>
  
  <div>
    <label class="block text-gray-600 mb-1" for="opciones" >Local</label>
    <select id="opciones" name="opciones">
      <option value="opcion1">Local Guernica</option>
      <option value="opcion2">Central Glew</option>
    </select>
  </div>
  
  <div>
    <label class="block text-gray-600 mb-1">Fecha</label>
    <input type="text" name="fecha" id="fecha" required readonly class="w-full border rounded-lg p-2 bg-gray-100">
  </div>
  
  <div class="grid grid-cols-2 gap-3">
    <div>
      <label class="block text-gray-600 mb-1">Pollo</label>
      <input type="number" name="pollo" class="w-full border rounded-lg p-2">
    </div>
    <div>
      <label class="block text-gray-600 mb-1">Milanesa</label>
      <input type="number" name="mila" class="w-full border rounded-lg p-2">
    </div>
    <div>
      <label class="block text-gray-600 mb-1">Pata</label>
      <input type="number" name="pata" class="w-full border rounded-lg p-2">
    </div>
    <div>
      <label class="block text-gray-600 mb-1">Alita</label>
      <input type="number" name="alita" class="w-full border rounded-lg p-2">
    </div>
    <div>
      <label class="block text-gray-600 mb-1">Suprema</label>
      <input type="number" name="suprema" class="w-full border rounded-lg p-2">
    </div>
    <div>
      <label class="block text-gray-600 mb-1">Menudo</label>
      <input type="number" name="menudo" class="w-full border rounded-lg p-2">
    </div>
    <div class="col-span-2">
      <label class="block text-gray-600 mb-1">Rebosador</label>
      <input type="number" name="rebosador" class="w-full border rounded-lg p-2">
    </div>
  </div>
  
  <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">
    Enviar Pedido
  </button>
</form>

</div>
<script>
    // Establecer fecha actual automáticamente
    const fechaInput = document.getElementById('fecha') as HTMLInputElement;
    if (fechaInput) {
        const hoy = new Date();
        const dia = String(hoy.getDate()).padStart(2, '0');
        const mes = String(hoy.getMonth() + 1).padStart(2, '0');
        const año = hoy.getFullYear();
        fechaInput.value = `${dia}/${mes}/${año}`;
    }

    // Manejar envío del formulario
    const form = document.getElementById('pedidoForm');
    if (form) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const form = e.target as HTMLFormElement;
            const formData = new FormData(form);
            
            const data = {
                local: formData.get('opciones'),
                fecha: formData.get('fecha'),
                pollo: Number(formData.get('pollo') || 0),
                mila: Number(formData.get('mila') || 0),
                pata: Number(formData.get('pata') || 0),
                alita: Number(formData.get('alita') || 0),
                suprema: Number(formData.get('suprema') || 0),
                menudo: Number(formData.get('menudo') || 0),
                rebosador: Number(formData.get('rebosador') || 0),
            };

            try {
                // Enviar el formulario usando la acción de Astro
                const formData = new FormData(form);
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData
                });

                // Verificar el tipo de contenido
                const contentType = response.headers.get("content-type");
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('El servidor no respondió con JSON válido. Verifica la URL del servidor.');
                }

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    console.log('Respuesta del servidor:', result.data); // Para debugging
                    form.reset();
                    const fechaInput = document.getElementById('fecha') as HTMLInputElement;
                    if (fechaInput) {
                        const hoy = new Date();
                        const dia = String(hoy.getDate()).padStart(2, '0');
                        const mes = String(hoy.getMonth() + 1).padStart(2, '0');
                        const año = hoy.getFullYear();
                        fechaInput.value = `${dia}/${mes}/${año}`;
                    }
                } else {
                    // Mostrar errores de validación
                    const errorContainer = document.getElementById('error-container');
                    if (errorContainer) {
                        errorContainer.innerHTML = `<div class="text-red-500">${result.message}</div>`;
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al enviar el pedido');
            }
        });
    }
</script>